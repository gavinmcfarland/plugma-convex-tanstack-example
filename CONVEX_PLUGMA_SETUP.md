# Convex + Svelte + Plugma Integration Guide

This document explains how to integrate Convex (a backend-as-a-service) with Svelte and Plugma (Figma plugin framework) to create persistent, real-time data storage in your Figma plugins.

## Table of Contents

1. [Overview](#overview)
2. [Prerequisites](#prerequisites)
3. [Installation](#installation)
4. [Configuration](#configuration)
5. [Project Structure](#project-structure)
6. [Setting Up Convex](#setting-up-convex)
7. [Component Setup](#component-setup)
8. [Using Queries and Mutations](#using-queries-and-mutations)
9. [Network Access Configuration](#network-access-configuration)
10. [Common Issues and Solutions](#common-issues-and-solutions)
11. [Best Practices](#best-practices)

## Overview

Convex provides a real-time backend for your Figma plugin, allowing you to:
- Store data persistently in the cloud
- Sync data across multiple plugin instances
- Handle real-time updates automatically
- Use TypeScript types generated from your schema

**Key Challenge**: Plugma uses Svelte 5 runes, and Convex's `setupConvex` must be called within a Svelte component context (not in plain TypeScript files).

## Prerequisites

- Node.js installed
- Figma desktop app
- A Convex account (free tier available)
- Basic understanding of Svelte and TypeScript

## Installation

### 1. Install Convex Packages

```bash
pnpm add convex convex-svelte
```

This installs:
- `convex`: The core Convex client and server libraries
- `convex-svelte`: Svelte-specific hooks and utilities

### 2. Initialize Convex

Run the Convex setup command:

```bash
npx convex dev
```

This will:
- Prompt you to log in with GitHub (if not already logged in)
- Create a new Convex project or connect to an existing one
- Generate the `src/convex/_generated` folder with TypeScript types
- Create a `.env.local` file with your `VITE_CONVEX_URL`
- Start watching for changes to your Convex functions

## Configuration

### 1. Create `convex.json`

Create a `convex.json` file in your project root:

```json
{
  "functions": "src/convex/"
}
```

This tells Convex where to find your backend functions. We use `src/convex/` instead of the default `convex/` because SvelteKit (and Plugma) prefer keeping code under `src/`.

### 2. Create Convex URL Configuration

Create `src/ui/convex.ts`:

```typescript
// Convex URL - will be set via environment variable when running `npx convex dev`
// Convex creates a .env.local file with VITE_CONVEX_URL
export const CONVEX_URL = import.meta.env.VITE_CONVEX_URL || "";
```

This reads the Convex deployment URL from environment variables that Convex sets up automatically.

### 3. Update `manifest.json` for Network Access

Figma plugins need explicit permission to access external APIs. Update your `manifest.json`:

```json
{
  "networkAccess": {
    "allowedDomains": ["*"],
    "devAllowedDomains": ["ws://localhost:3210"],
    "reasoning": "This plugin needs to access the Convex API to save and retrieve data."
  }
}
```

**Important Notes:**
- `allowedDomains: ["*"]` allows access to all domains (required for Convex cloud deployments)
- `devAllowedDomains` allows WebSocket connections to local Convex dev server
- For production, you might want to restrict to specific Convex domains like `["https://*.convex.cloud", "https://*.convex.site"]`

## Project Structure

After setup, your project should have this structure:

```
figma-convex/
├── convex.json                 # Convex configuration
├── manifest.json               # Figma plugin manifest (with network access)
├── .env.local                  # Convex URL (generated by `npx convex dev`)
├── src/
│   ├── convex/                 # Convex backend functions
│   │   ├── _generated/         # Generated TypeScript types (auto-generated)
│   │   │   ├── api.d.ts
│   │   │   └── dataModel.d.ts
│   │   ├── schema.ts           # Database schema
│   │   └── todos.ts            # Example: Todo functions
│   ├── ui/
│   │   ├── convex.ts           # Convex URL configuration
│   │   ├── ConvexProvider.svelte  # Component that sets up Convex
│   │   ├── App.svelte          # Your main app component
│   │   └── ui.ts               # Entry point (mounts ConvexProvider)
│   └── main/
│       └── main.ts             # Figma plugin main thread
```

## Setting Up Convex

### 1. Define Database Schema

Create `src/convex/schema.ts`:

```typescript
import { defineSchema, defineTable } from "convex/server";
import { v } from "convex/values";

export default defineSchema({
  todos: defineTable({
    text: v.string(),
    completed: v.boolean(),
  }),
});
```

This defines your database tables and their schemas using Convex's validation system.

### 2. Create Convex Functions

Create `src/convex/todos.ts` (or any function file):

```typescript
import { query, mutation } from "./_generated/server";
import { v } from "convex/values";

// Query to get all todos
export const get = query({
  args: {},
  handler: async (ctx) => {
    const todos = await ctx.db.query("todos").collect();
    return todos;
  },
});

// Mutation to add a new todo
export const add = mutation({
  args: {
    text: v.string(),
  },
  handler: async (ctx, args) => {
    const todoId = await ctx.db.insert("todos", {
      text: args.text,
      completed: false,
    });
    return todoId;
  },
});

// Mutation to toggle todo completion
export const toggle = mutation({
  args: {
    id: v.id("todos"),
  },
  handler: async (ctx, args) => {
    const todo = await ctx.db.get(args.id);
    if (!todo) {
      throw new Error("Todo not found");
    }
    await ctx.db.patch(args.id, {
      completed: !todo.completed,
    });
  },
});

// Mutation to delete a todo
export const remove = mutation({
  args: {
    id: v.id("todos"),
  },
  handler: async (ctx, args) => {
    await ctx.db.delete(args.id);
  },
});
```

**Key Points:**
- `query`: For reading data (automatically subscribes to changes)
- `mutation`: For writing data (create, update, delete)
- Functions are automatically exposed as `api.todos.get`, `api.todos.add`, etc.
- TypeScript types are generated automatically in `_generated/api.d.ts`

## Component Setup

### ⚠️ CRITICAL: Component Context Requirement

**The Problem**: `setupConvex` uses Svelte's `setContext`, which can only be called during component initialization. You cannot call it in plain TypeScript files like `ui.ts`.

**The Solution**: Create a wrapper component that sets up Convex, then renders your app.

### 1. Create ConvexProvider Component

Create `src/ui/ConvexProvider.svelte`:

```svelte
<script lang="ts">
	import { setupConvex } from 'convex-svelte';
	import { CONVEX_URL } from './convex';
	import App from './App.svelte';

	// Set up Convex client during component initialization
	if (CONVEX_URL) {
		setupConvex(CONVEX_URL);
	} else {
		console.warn('CONVEX_URL not set. Please run "npx convex dev" to set up Convex.');
	}
</script>

<App />
```

**Why this works**: `setupConvex` is called in the component's script block, which runs during component initialization, allowing `setContext` to work properly.

### 2. Update Entry Point

Update `src/ui/ui.ts`:

```typescript
import { mount } from 'svelte';
import './styles.css';
import ConvexProvider from './ConvexProvider.svelte';

const app = mount(ConvexProvider, {
	target: document.getElementById('app')!,
});

export default app;
```

Mount `ConvexProvider` instead of `App` directly.

## Using Queries and Mutations

### In Your App Component

In `src/ui/App.svelte`:

```svelte
<script lang="ts">
	import { useQuery, useConvexClient } from 'convex-svelte';
	import { api } from '../convex/_generated/api';
	import type { Id } from '../convex/_generated/dataModel';

	// Get Convex client for mutations
	const convex = useConvexClient();

	// Query todos from Convex (reactive, automatically updates)
	const todosQuery = useQuery(api.todos.get, {});

	async function addTodo() {
		if (todoText.trim()) {
			await convex.mutation(api.todos.add, { text: todoText.trim() });
			todoText = '';
		}
	}

	async function toggleTodo(id: Id<'todos'>) {
		await convex.mutation(api.todos.toggle, { id });
	}

	async function deleteTodo(id: Id<'todos'>) {
		await convex.mutation(api.todos.remove, { id });
	}
</script>

<!-- Use the query result -->
{#if todosQuery.isLoading}
	<p>Loading...</p>
{:else if todosQuery.error}
	<p>Error: {todosQuery.error.toString()}</p>
{:else if todosQuery.data}
	{#each todosQuery.data as todo (todo._id)}
		<!-- Render todo -->
	{/each}
{/if}
```

### Key Concepts

1. **Queries (`useQuery`)**: 
   - Automatically subscribes to data changes
   - Returns reactive object with `data`, `isLoading`, `error`, `isStale`
   - Data updates automatically when backend changes

2. **Mutations (`convex.mutation`)**: 
   - Use `useConvexClient()` to get the client
   - Call `convex.mutation(api.functionName, args)`
   - Returns a Promise
   - After mutation, queries automatically update

3. **TypeScript Types**:
   - `api` object contains all your functions with full type safety
   - `Id<'tableName'>` is the type for document IDs
   - All types are auto-generated from your schema

## Network Access Configuration

### Development

For local development with `npx convex dev`:

```json
{
  "networkAccess": {
    "allowedDomains": ["*"],
    "devAllowedDomains": ["ws://localhost:3210"],
    "reasoning": "Access to Convex API for data storage."
  }
}
```

### Production

For production deployments, you can be more specific:

```json
{
  "networkAccess": {
    "allowedDomains": [
      "https://*.convex.cloud",
      "https://*.convex.site",
      "wss://*.convex.cloud",
      "wss://*.convex.site"
    ],
    "reasoning": "Access to Convex cloud API for data storage."
  }
}
```

## Common Issues and Solutions

### 1. Error: "setContext can only be used during component initialization"

**Problem**: Calling `setupConvex` in `ui.ts` (plain TypeScript file).

**Solution**: Create a `ConvexProvider.svelte` component and call `setupConvex` there. See [Component Setup](#component-setup).

### 2. Error: "useMutation is not exported from convex-svelte"

**Problem**: `convex-svelte` doesn't export `useMutation`.

**Solution**: Use `useConvexClient()` + `convex.mutation()` instead:

```typescript
// ❌ Wrong
const addTodo = useMutation(api.todos.add);

// ✅ Correct
const convex = useConvexClient();
await convex.mutation(api.todos.add, { text: "..." });
```

### 3. Error: "CONVEX_URL not set"

**Problem**: Environment variable not loaded.

**Solutions**:
- Run `npx convex dev` to generate `.env.local`
- Restart your dev server after running `npx convex dev`
- Check that `.env.local` contains `VITE_CONVEX_URL=...`
- Verify Vite is loading the environment variable

### 4. Error: Network access denied

**Problem**: Figma plugin doesn't have permission to access Convex.

**Solution**: Update `manifest.json` with `networkAccess` configuration. See [Network Access Configuration](#network-access-configuration).

### 5. TypeScript errors about missing `_generated` files

**Problem**: Convex hasn't generated TypeScript types yet.

**Solution**: 
- Run `npx convex dev` at least once
- The `src/convex/_generated` folder should be created automatically
- If it's missing, check that `convex.json` is configured correctly

### 6. Query not updating after mutation

**Problem**: This shouldn't happen - queries auto-update.

**Solutions**:
- Check that your mutation is actually completing (no errors)
- Verify the mutation is writing to the correct table
- Check browser console for errors
- Ensure `useQuery` is being used (not a one-time fetch)

## Best Practices

### 1. Component Structure

```
ConvexProvider.svelte (sets up Convex)
  └── App.svelte (uses Convex hooks)
      └── Child components (can also use Convex hooks)
```

### 2. Error Handling

Always handle loading and error states:

```svelte
{#if query.isLoading}
	<p>Loading...</p>
{:else if query.error}
	<p>Error: {query.error.toString()}</p>
{:else if query.data}
	<!-- Render data -->
{/if}
```

### 3. Type Safety

Use generated types:

```typescript
import type { Id } from '../convex/_generated/dataModel';

function deleteItem(id: Id<'todos'>) {
	// Type-safe!
}
```

### 4. Schema Validation

Always define schemas with validation:

```typescript
export default defineSchema({
  todos: defineTable({
    text: v.string(),        // Required string
    completed: v.boolean(),  // Required boolean
    createdAt: v.number(),   // Optional: v.optional(v.number())
  }),
});
```

### 5. Function Organization

Organize functions by domain:

```
src/convex/
  ├── todos.ts      # Todo-related functions
  ├── users.ts      # User-related functions
  └── analytics.ts  # Analytics functions
```

### 6. Development Workflow

1. Start Convex dev server: `npx convex dev`
2. Start plugin dev server: `pnpm dev`
3. Make changes to functions - Convex auto-reloads
4. Make changes to UI - Vite auto-reloads

## Summary

**Key Takeaways**:

1. ✅ Install `convex` and `convex-svelte` packages
2. ✅ Run `npx convex dev` to set up Convex
3. ✅ Create `convex.json` pointing to `src/convex/`
4. ✅ Create `ConvexProvider.svelte` to set up Convex (CRITICAL!)
5. ✅ Use `useQuery` for reactive data subscriptions
6. ✅ Use `useConvexClient()` + `convex.mutation()` for mutations
7. ✅ Configure `manifest.json` for network access
8. ✅ Handle loading and error states in your UI

**The Most Important Point**: Always set up Convex in a Svelte component, not in plain TypeScript files. Use the `ConvexProvider` pattern!

## Additional Resources

- [Convex Documentation](https://docs.convex.dev)
- [Convex Svelte Quickstart](https://docs.convex.dev/quickstart/svelte)
- [Plugma Documentation](https://plugma.dev/docs)
- [Svelte 5 Documentation](https://svelte.dev/docs)

## Example: Complete Todo App

See the `src/ui/App.svelte` and `src/convex/todos.ts` files in this project for a complete working example of a todo app with Convex integration.

## Quick Reference

### File Checklist

When setting up Convex with Plugma, ensure you have:

- [ ] `convex.json` - Convex configuration
- [ ] `src/convex/schema.ts` - Database schema
- [ ] `src/convex/*.ts` - Convex functions (queries/mutations)
- [ ] `src/ui/convex.ts` - Convex URL configuration
- [ ] `src/ui/ConvexProvider.svelte` - Component that sets up Convex
- [ ] `src/ui/ui.ts` - Updated to mount ConvexProvider
- [ ] `manifest.json` - Updated with network access
- [ ] `.env.local` - Generated by `npx convex dev` (contains VITE_CONVEX_URL)

### Common Commands

```bash
# Install packages
pnpm add convex convex-svelte

# Initialize Convex (first time)
npx convex dev

# Start Convex dev server (ongoing)
npx convex dev

# Start plugin dev server (in separate terminal)
pnpm dev

# Generate TypeScript types (automatic with convex dev)
# Types are in src/convex/_generated/
```

### API Reference

#### Queries

```typescript
// In a Svelte component
const query = useQuery(api.todos.get, {});
// Returns: { data, isLoading, error, isStale }
```

#### Mutations

```typescript
// In a Svelte component
const convex = useConvexClient();
await convex.mutation(api.todos.add, { text: "..." });
```

#### Convex Functions

```typescript
// Query
export const get = query({
  args: {},
  handler: async (ctx) => {
    return await ctx.db.query("todos").collect();
  },
});

// Mutation
export const add = mutation({
  args: { text: v.string() },
  handler: async (ctx, args) => {
    return await ctx.db.insert("todos", { text: args.text });
  },
});
```

### Troubleshooting Checklist

If something isn't working:

1. ✅ Have you run `npx convex dev`?
2. ✅ Is `.env.local` present with `VITE_CONVEX_URL`?
3. ✅ Have you restarted your dev server after running `npx convex dev`?
4. ✅ Is `ConvexProvider.svelte` set up correctly?
5. ✅ Is `manifest.json` configured for network access?
6. ✅ Are you using `useConvexClient()` + `convex.mutation()` (not `useMutation`)?
7. ✅ Are you calling `setupConvex` in a component (not in `ui.ts`)?
8. ✅ Do you have `src/convex/_generated/api.d.ts` (generated types)?

## Version Information

This guide was created for:
- **Plugma**: ^2.2.3
- **Svelte**: ^5.0.5
- **Convex**: ^1.29.0
- **convex-svelte**: ^0.0.12

If you're using different versions, some APIs may differ. Refer to the official documentation for your specific versions.

